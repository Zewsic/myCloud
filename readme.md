# Документация по модулу `CustomTGClient`

Данная документация показывает состав модуля `CustomTGClient`, в том числе его методы и примеры использования.

## Класс `CustomTGClientManager`

Данный класс предназначен для управления телеграм-клиентами. Он содержит функции для авторизации всех клиентов, получения следующего клиента по кольцевому принципу, учет количества запросов к аккаунту, и запуск тех самых запросов.

### Методы

Ниже представлено описание работы методов. Более подробное описание аргументов, возвратов и возможных ошибок вы можете прочитать в описании каждого метода в файле с кодом.

1. `auth_all_clients` - Авторизует всех клиентов из базы данных. Выводит на экран результат авторизации для каждого аккаунта.
2. `check_and_reset_all_counts` - Сбрасывает стетчик запросов в случае, если с момента прошлого сброса прошло более чем 24 часа.
3. `get_next_account` - Возвращает следующий работоспособный аккаунт по кольцевому принципу.
4. `make_request` - делает запрос. Перед запросом проверяет необходимость сброса счетчиков запроса, после чего получает аккаунт через функцию `get_next_account`, отправляет сообщение в чат, ждет необюходимое время, ищет следующее сообщение по ключевому слову, отмечает его как прочитанное и возвращает его.

### Примеры использования

В зависимости от задач, модуль можно использовать по разному. Ниже представлен один из примеров использования.

```python
from CustomTGClient import CustomTGClientManager

Manager = CustomTGClientManager()
Manager.auth_all_clients()

for _ in range(4):
    msg = Manager.make_request("example_username", "/get_me", "You is", 5)
    print("Persion is " + msg.text.split(" ")[2])
```

В данном примере мы авторизуем все аккаунты и делаем 4 запроса. Запросы делюатся аккаунтами по кольцевому принципу.
В каждом запросе мы пишем команду `get_me` в чат `example_username` и ожидаем ответ со словами `You is` в течении 5 секунд. Если ответа не будет, программа вылетет с ошибкой.
После получения ответа мы выводим строку `Person is` вместе с тем, что идет после ключевых слов.

### Дополнительно

Вы также можете быстро добавлять аккаунты телеграм, вызвав данный класс из командной строки
```bash
python3 CustomTGClient/__init__.py
```
В данном случае вы будете добавлять аккаунты телеграм, пока не нажмете клавишу `enter` на этапе ввода номера телефона.

## Класс `CustomTGClient`

Данный класс является расширенной версией телеграм клиента. В него включены функции отправки запроса, поиска ответа, просмотра сообщения. Также класс умеет взаимодействовать с базой данных.

### Методы

Ниже представлено описание работы методов. Более подробное описание аргументов, возвратов и возможных ошибок вы можете прочитать в описании каждого метода в файле с кодом.

1. `load_from_db` - Метод статичный, используется для получения объекта `CustomTGClient` из базы данных по идентификатору телеграма.
2. `start` - Пытается запустить клиент, обновляет его статус и идентификатор, сохраняет в базу данных.
3. `stop` - Оставливает клиент.
4. `is_started` - Возвращает состояние работы клиента.
5. `save_to_db` - Сохраняет клиента в базу данных.
6. `send_request` - Отправляет сообщение в чат.
7. `get_response` - Ищет сообщение, кодержазее ключевое слово. Можно указать идентификатор сообщения, от которого будет идти поиск.
8. `mark_as_read` - Отмечает сообщение как прочитанное.

### Примеры использования

В зависимости от задач, модуль можно использовать по разному. Ниже представлен один из примеров использования.

```python
from CustomTGClient import СustomTGClient

client_1 = СustomTGClient.load_from_db(1123234214)
client_2 = CustomTGClient(pyrogram.Client("+79034285024", api_id=5, api_hash="1c5c96d5edd401b1ed40db3fb5633e2d",
                                        device_model="iPhone 13 Pro",
                                        system_version="15.7.1",
                                        app_version="9.8.0",
                                        phone_number="+79034285024",
                                        in_memory=True))

client_1.start()

client_1.send_request("some_chat", "hello!")
message = client_2.get_response("some_chat", "hello!")
message_id = client_2.send_request("some_chat", "hi!, " + message.from_user.first_name)
client_1.mark_as_read("some_chat", message_id)

client_2.stop()
```

В данном примере мы загружаем один клиент из базы данных, а второй добавляем.
Мы запускаем первый клиент, после чего отправляем сообщение в чат `some_chat` с текстом `hello`.
Затем, испольуя второй клиент мы ищем сообщение с этим же текстом, чтобы после этого написать `Hi, ` с именем первого аккаунта.
После этого мы прочитываем новое сообщение с первого аккаунта.

### Дополнительно

Для добавления аккаунта в базу данных используется конструктор класса, в аргументы передайте клиент пюреграма, после чего сохраните его. Например:

```python
client = CustomTGClient(pyrogram.Client("name", api_id=5, api_hash="1c5c96d5edd401b1ed40db3fb5633e2d"))
client.save_to_db()
```

Также, для увеличения производительности используется КЕШ с аккаунтами. Если вы хотите загрузить аккаунт из базы данных в обход кеша, используйте следующую конструкцию:
```python
client = СustomTGClient.load_from_db(1123234214, True)
```

Также, вам не нужно запускать клиент перед сохранением в БД, или выполненеим действий, т.к. он будет запущен автоматически.

## Базы данных

### Классы

1. `Memory` - Используется для хранения каких-либо значений. Имеет параметры ключа и значения. Таблица - `memory`
2. `TGClient` - Используется для хранения данных клиентов. Хранит в себе ID, имя, статус, сессию, количество запросов и геолокацию. Таблица - `clients`

### Методы

Ниже представлено описание работы методов. Более подробное описание аргументов, возвратов и возможных ошибок вы можете прочитать в описании каждого метода в файле с кодом.

1. `is_tgclient_exists` - Проверяет наличие клиента в базе данных.
2. `is_true_accounts_exists` - Проверяет наличие хотя-бы одного работоспособного клиента в бд.
3. `get_value_from_memory` - Получает значение из бд `memory`
4. `set_value_in_memory` - Сохраняет значение в бд `memory`

### Дополнительно

Во время инициализации файла, тот создает базу данных.

## Ошибки

Для данного клиенты было разработано несколько типов исключений, вы можете их обрабатывать как обычные исключения.

1. `AccountBannedException` - Возникает в случае, если аккаунт заблокирован, или не-авторизован.
2. `NoResponseFoundException` - Возникает в случае, если аккаунт не нашел ответ.
3. `AllAccountsAreDeadException` - Возникает, если в БД не осталось живых аккаунтов.
4. `MakeRequestException` - Возникает, если в случае отправки запроса произошла какая-то ошибка.
5. `GetResponseException` - Возникает, если в случае получения ответа произошла какая-то ошиюка.
6. `MarkAsReadException` - Возникает, если в случае прочтения сообщения произошла какая-то ошибка.

## Не забудьте оставить положительный отзыв!